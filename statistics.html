<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»Ÿè®¡æŸ¥è¯¢ - é£è¡Œç»å†å½•å…¥ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            writing-mode: horizontal-tb;
            direction: ltr;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .back-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 30px;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .tag-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .tag-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .stat-label {
            font-size: 0.95em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .details-table {
            margin-top: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
            <h1>ğŸ“Š ç»Ÿè®¡æŸ¥è¯¢</h1>
        </div>
        
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>é€‰æ‹©äººå‘˜ï¼ˆå¯é€‰ï¼‰</label>
                    <select id="personName">
                        <option value="">-- å…¨éƒ¨äººå‘˜ --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>é€‰æ‹©æœºå‹ï¼ˆå¯é€‰ï¼‰</label>
                    <select id="aircraftTypeFilter">
                        <option value="">-- å…¨éƒ¨æœºå‹ --</option>
                        <option value="S76C+">S76C+</option>
                        <option value="S76C++">S76C++</option>
                        <option value="S76D">S76D</option>
                        <option value="G2">G2</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>é£è¡Œç§ç±»ï¼ˆå¯é€‰ï¼‰</label>
                    <select id="flightTypeFilter">
                        <option value="">-- å…¨éƒ¨ç§ç±» --</option>
                        <option value="è®­ç»ƒ">è®­ç»ƒ</option>
                        <option value="è½¬åœº">è½¬åœº</option>
                        <option value="æµ·ä¸Šè®­ç»ƒ">æµ·ä¸Šè®­ç»ƒ</option>
                        <option value="æ•‘åŠ©">æ•‘åŠ©</option>
                        <option value="è¡¥å½•">è¡¥å½•</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="dateTo">
                </div>
            </div>
            
            <div class="filter-group">
                <label>ç»Ÿè®¡æ ‡ç­¾ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div class="tag-filters">
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-total" value="totalTime" checked>
                        <label for="tag-total" style="margin: 0;">æ€»æ—¶é—´</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-captain" value="captainTime">
                        <label for="tag-captain" style="margin: 0;">æœºé•¿</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-captainCC" value="captainCrossCountry">
                        <label for="tag-captainCC" style="margin: 0;">æœºé•¿è½¬åœº</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-copilot" value="copilotTime">
                        <label for="tag-copilot" style="margin: 0;">å‰¯é©¾é©¶</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-copilotCC" value="copilotCrossCountry">
                        <label for="tag-copilotCC" style="margin: 0;">å‰¯é©¾é©¶è½¬åœº</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-spic" value="spic">
                        <label for="tag-spic" style="margin: 0;">SPIC</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-instrument" value="instrument">
                        <label for="tag-instrument" style="margin: 0;">ä»ªè¡¨</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-night" value="nightFlight">
                        <label for="tag-night" style="margin: 0;">å¤œèˆª</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-landingsDay" value="landingsDay">
                        <label for="tag-landingsDay" style="margin: 0;">ç€é™†æ¬¡æ•°(æ˜¼)</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-landingsNight" value="landingsNight">
                        <label for="tag-landingsNight" style="margin: 0;">ç€é™†æ¬¡æ•°(å¤œ)</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-rescued" value="rescued">
                        <label for="tag-rescued" style="margin: 0;">æ•‘åŠ©äººæ•°</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-instructor" value="instructor">
                        <label for="tag-instructor" style="margin: 0;">å¸¦é£</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-instructorCC" value="instructorCrossCountry">
                        <label for="tag-instructorCC" style="margin: 0;">å¸¦é£è½¬åœº</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-aircraftType" value="aircraftType">
                        <label for="tag-aircraftType" style="margin: 0;">æœºå‹</label>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="calculateStats()">æŸ¥è¯¢ç»Ÿè®¡</button>
        </div>
        
        <div id="statsResults" style="display: none;">
            <div class="stats-grid" id="statsGrid">
            </div>
            
            <div class="details-table">
                <h3 style="margin: 30px 0 15px 0;">è¯¦ç»†ç»Ÿè®¡</h3>
                <table id="detailsTable">
                    <thead>
                        <tr>
                            <th>ç»Ÿè®¡é¡¹</th>
                            <th>æ•°å€¼</th>
                        </tr>
                    </thead>
                    <tbody id="detailsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // åŠ è½½äººå‘˜åˆ—è¡¨
        function loadPersonList() {
            const records = JSON.parse(localStorage.getItem('flightRecords') || '[]');
            const personSet = new Set();
            
            records.forEach(record => {
                if (record.captain) personSet.add(record.captain);
                if (record.copilot) personSet.add(record.copilot);
            });
            
            const personSelect = document.getElementById('personName');
            const currentValue = personSelect.value;
            
            personSelect.innerHTML = '<option value="">-- å…¨éƒ¨äººå‘˜ --</option>';
            Array.from(personSet).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                personSelect.appendChild(option);
            });
            
            if (currentValue) {
                personSelect.value = currentValue;
            }
        }
        
        function calculateStats() {
            const personName = document.getElementById('personName').value;
            const aircraftType = document.getElementById('aircraftTypeFilter').value;
            const flightType = document.getElementById('flightTypeFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            // è·å–é€‰ä¸­çš„æ ‡ç­¾
            const selectedTags = [];
            document.querySelectorAll('.tag-checkbox input[type="checkbox"]:checked').forEach(cb => {
                selectedTags.push(cb.value);
            });
            
            if (selectedTags.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç»Ÿè®¡æ ‡ç­¾');
                return;
            }
            
            // åŠ è½½è®°å½•
            const records = JSON.parse(localStorage.getItem('flightRecords') || '[]');
            
            // ç­›é€‰æ—¥æœŸã€å§“åã€æœºå‹ã€é£è¡Œç§ç±»
            let filteredRecords = records;
            if (dateFrom || dateTo || personName || aircraftType || flightType) {
                filteredRecords = records.filter(record => {
                    const matchFrom = !dateFrom || record.date >= dateFrom;
                    const matchTo = !dateTo || record.date <= dateTo;
                    const matchName = !personName || record.captain === personName || record.copilot === personName;
                    const matchAircraft = !aircraftType || record.aircraftType === aircraftType;
                    const matchFlightType = !flightType || record.flightType === flightType;
                    return matchFrom && matchTo && matchName && matchAircraft && matchFlightType;
                });
            }
            
            // è®¡ç®—ç»Ÿè®¡
            const stats = {};
            selectedTags.forEach(tag => {
                stats[tag] = { total: 0, count: 0, aircraftTypes: new Set() };
            });
            
            filteredRecords.forEach(record => {
                const isCaptain = personName ? record.captain === personName : true;
                const isCopilot = personName ? record.copilot === personName : true;
                
                selectedTags.forEach(tag => {
                    if (tag === 'instrument' || tag === 'nightFlight') {
                        // å¦‚æœæ˜¯æŒ‰å§“åç»Ÿè®¡ï¼Œéœ€è¦åˆ¤æ–­è¯¥äººå‘˜æ˜¯å¦å‚ä¸è¯¥æ¬¡é£è¡Œ
                        if (personName && !isCaptain && !isCopilot) return;
                        
                        // ä»ªè¡¨å’Œå¤œèˆªç°åœ¨æ˜¯æ—¶é—´æ ¼å¼ï¼ˆHH:MMï¼‰
                        const time = record[tag];
                        if (time && time !== '00:00') {
                            const [h, m] = time.split(':').map(Number);
                            stats[tag].total += h * 60 + m;
                            stats[tag].count++;
                        }
                    } else if (tag === 'landingsDay' || tag === 'landingsNight' || tag === 'rescued') {
                        if (personName && !isCaptain && !isCopilot) return;
                        
                        stats[tag].total += parseInt(record[tag]) || 0;
                        stats[tag].count++;
                    } else if (tag === 'aircraftType') {
                        if (personName && !isCaptain && !isCopilot) return;
                        
                        if (record.aircraftType) {
                            stats[tag].aircraftTypes.add(record.aircraftType);
                            stats[tag].count++;
                        }
                    } else {
                        // æ—¶é—´ç±»å‹
                        let time = null;
                        
                        // æŒ‰å§“åç»Ÿè®¡æ—¶ï¼Œéœ€è¦æ ¹æ®è§’è‰²é€‰æ‹©å¯¹åº”çš„æ—¶é—´
                        if (personName) {
                            if (isCaptain) {
                                if (tag === 'captainTime' || tag === 'totalTime') {
                                    time = tag === 'captainTime' ? record.captainTime : record.totalTime;
                                } else if (tag === 'captainCrossCountry') {
                                    time = record.captainCrossCountry;
                                }
                            }
                            if (isCopilot) {
                                if (tag === 'copilotTime' || tag === 'totalTime' || tag === 'spic') {
                                    time = tag === 'copilotTime' ? record.copilotTime : 
                                           tag === 'spic' ? record.spic : record.totalTime;
                                } else if (tag === 'copilotCrossCountry') {
                                    time = record.copilotCrossCountry;
                                }
                            }
                            
                            // å¸¦é£å’Œå¸¦é£è½¬åœºï¼šå¸¦é£æ—¶é—´é€šå¸¸ç­‰äºå‰¯é©¾é©¶æ—¶é—´ï¼Œå¸¦é£è½¬åœºç­‰äºå‰¯é©¾é©¶è½¬åœº
                            if (tag === 'instructor') {
                                // å¸¦é£æ—¶é—´ = å‰¯é©¾é©¶æ—¶é—´
                                time = isCopilot ? record.copilotTime : null;
                            } else if (tag === 'instructorCrossCountry') {
                                // å¸¦é£è½¬åœº = å‰¯é©¾é©¶è½¬åœº
                                time = isCopilot ? record.copilotCrossCountry : null;
                            }
                            
                            // å¦‚æœæ˜¯æ€»æ—¶é—´ï¼Œä¸”è¯¥äººå‘˜å‚ä¸äº†é£è¡Œï¼Œä½¿ç”¨æ€»æ—¶é—´
                            if (tag === 'totalTime' && (isCaptain || isCopilot)) {
                                time = record.totalTime;
                            }
                        } else {
                            // å…¨éƒ¨ç»Ÿè®¡ï¼Œç›´æ¥ä½¿ç”¨è®°å½•ä¸­çš„æ—¶é—´
                            time = record[tag];
                        }
                        
                        if (time && time !== '00:00') {
                            const [h, m] = time.split(':').map(Number);
                            stats[tag].total += h * 60 + m;
                            stats[tag].count++;
                        }
                    }
                });
            });
            
            // æ˜¾ç¤ºç»“æœ
            displayStats(stats, selectedTags, personName);
        }
        
        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }
        
        function getTagLabel(tag) {
            const labels = {
                'totalTime': 'æ€»æ—¶é—´',
                'captainTime': 'æœºé•¿æ—¶é—´',
                'captainCrossCountry': 'æœºé•¿è½¬åœº',
                'copilotTime': 'å‰¯é©¾é©¶æ—¶é—´',
                'copilotCrossCountry': 'å‰¯é©¾é©¶è½¬åœº',
                'spic': 'SPIC',
                'instrument': 'ä»ªè¡¨',
                'nightFlight': 'å¤œèˆª',
                'landingsDay': 'ç€é™†æ¬¡æ•°(æ˜¼)',
                'landingsNight': 'ç€é™†æ¬¡æ•°(å¤œ)',
                'rescued': 'æ•‘åŠ©äººæ•°',
                'instructor': 'å¸¦é£',
                'instructorCrossCountry': 'å¸¦é£è½¬åœº',
                'aircraftType': 'æœºå‹'
            };
            return labels[tag] || tag;
        }
        
        function displayStats(stats, selectedTags, personName) {
            const statsGrid = document.getElementById('statsGrid');
            const detailsBody = document.getElementById('detailsBody');
            
            statsGrid.innerHTML = '';
            detailsBody.innerHTML = '';
            
            // å¦‚æœæœ‰é€‰æ‹©äººå‘˜ï¼Œæ˜¾ç¤ºæ ‡é¢˜
            if (personName) {
                const titleRow = document.createElement('tr');
                titleRow.style.background = '#f8f9fa';
                titleRow.innerHTML = `
                    <td colspan="2" style="text-align: center; font-weight: 700; font-size: 1.1em; padding: 15px;">
                        ${personName} çš„ç»Ÿè®¡ç»“æœ
                    </td>
                `;
                detailsBody.appendChild(titleRow);
            }
            
            selectedTags.forEach(tag => {
                const stat = stats[tag];
                let value, unit;
                
                if (tag === 'instrument' || tag === 'nightFlight') {
                    // ä»ªè¡¨å’Œå¤œèˆªæ˜¾ç¤ºæ—¶é—´
                    value = formatTime(stat.total);
                    unit = '';
                } else if (tag === 'landingsDay' || tag === 'landingsNight' || tag === 'rescued') {
                    value = stat.total;
                    unit = tag === 'rescued' ? 'äºº' : 'æ¬¡';
                } else if (tag === 'aircraftType') {
                    value = Array.from(stat.aircraftTypes).join('ã€') || 'æ— ';
                    unit = '';
                } else {
                    value = formatTime(stat.total);
                    unit = '';
                }
                
                // ç»Ÿè®¡å¡ç‰‡
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-label">${getTagLabel(tag)}</div>
                    <div class="stat-value">${value}${unit}</div>
                `;
                statsGrid.appendChild(card);
                
                // è¯¦ç»†è¡¨æ ¼
                const row = document.createElement('tr');
                let detailText = `<strong>${value}${unit}</strong>`;
                if (tag === 'aircraftType') {
                    detailText += ` (å…± ${stat.count} ç§æœºå‹)`;
                } else if (tag !== 'instrument' && tag !== 'nightFlight' && !tag.includes('Time') && tag !== 'spic') {
                    detailText += ` (è®°å½•æ•°: ${stat.count})`;
                }
                
                row.innerHTML = `
                    <td>${getTagLabel(tag)}</td>
                    <td>${detailText}</td>
                `;
                detailsBody.appendChild(row);
            });
            
            document.getElementById('statsResults').style.display = 'block';
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–äººå‘˜åˆ—è¡¨
        loadPersonList();
    </script>
</body>
</html>
